<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gezgin</title>
    
    <!-- PWA -->
    <meta name="theme-color" content="#059669">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Harita CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 750: '#293548', 850: '#172033', 950: '#0b1121' }
                    }
                }
            }
        }
    </script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        input { font-size: 16px !important; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .dragging { opacity: 0.5; transform: scale(0.95); }
        #map-container { height: 100%; width: 100%; border-radius: 1rem; z-index: 0; }
        .leaflet-pane { z-index: 0 !important; }
        .leaflet-control { z-index: 1 !important; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 select-none transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- FIREBASE AYARLARI ---
        const firebaseConfig = {
            apiKey: "AIzaSyDTn2eXJbEiCnr-nwUlR7P2oDLX-KowCtQ",
            authDomain: "gezginapp-70b69.firebaseapp.com",
            projectId: "gezginapp-70b69",
            storageBucket: "gezginapp-70b69.firebasestorage.app",
            messagingSenderId: "120226629154",
            appId: "1:120226629154:web:147621c900c5a9f0e06c7b"
        };

        // --- İKONLAR ---
        const Icons = {
            MapPin: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
            CheckSquare: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>,
            Square: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/></svg>,
            Plus: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Users: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            ArrowRight: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            LogOut: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Map: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="21"/><line x1="15" x2="15" y1="3" y2="21"/></svg>,
            Copy: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            Trash2: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            History: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>,
            Settings: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            X: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
            Edit: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>,
            Google: (p) => <svg {...p} viewBox="0 0 24 24" width="24" height="24" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>,
            Home: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            List: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            Image: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            Grid: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>,
            Search: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Moon: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
            Sun: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            MessageSquare: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            Drag: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>,
            MapIcon: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s-8-10-8-14a8 8 0 0 1 16 0c0 4-8 14-8 14z"/><circle cx="12" cy="10" r="3"/></svg>,
            SortAsc: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m11 8-4 4 4 4"/><path d="M7 12h14"/><path d="M3 21h4"/><path d="M3 17h6"/><path d="M3 13h8"/><path d="M3 9h10"/><path d="M3 5h12"/></svg>,
            SortDesc: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m11 16 4-4-4-4"/><path d="M15 12H3"/><path d="M21 21h-4"/><path d="M21 17h-6"/><path d="M21 13h-8"/><path d="M21 9h-10"/><path d="M21 5h-12"/></svg>
        };

        const THEMES = {
            emerald: { name: 'Yeşil', bg: 'bg-emerald-600', text: 'text-emerald-600', light: 'bg-emerald-100', from: 'from-emerald-400', to: 'to-emerald-600', shadow: 'shadow-emerald-200' },
            purple: { name: 'Mor', bg: 'bg-purple-600', text: 'text-purple-600', light: 'bg-purple-100', from: 'from-purple-400', to: 'to-purple-600', shadow: 'shadow-purple-200' },
            blue: { name: 'Mavi', bg: 'bg-blue-600', text: 'text-blue-600', light: 'bg-blue-100', from: 'from-blue-400', to: 'to-blue-600', shadow: 'shadow-blue-200' },
            rose: { name: 'Gül', bg: 'bg-rose-600', text: 'text-rose-600', light: 'bg-rose-100', from: 'from-rose-400', to: 'to-rose-600', shadow: 'shadow-rose-200' },
            amber: { name: 'Turuncu', bg: 'bg-amber-500', text: 'text-amber-600', light: 'bg-amber-100', from: 'from-amber-400', to: 'to-amber-600', shadow: 'shadow-amber-200' },
            slate: { name: 'Siyah', bg: 'bg-slate-700', text: 'text-slate-700', light: 'bg-slate-200', from: 'from-slate-500', to: 'to-slate-800', shadow: 'shadow-slate-300' }
        };

        const CITY_COLORS = [
            'bg-orange-100 text-orange-700 border-orange-200 dark:bg-orange-900/30 dark:text-orange-300 dark:border-orange-800',
            'bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-800',
            'bg-pink-100 text-pink-700 border-pink-200 dark:bg-pink-900/30 dark:text-pink-300 dark:border-pink-800',
            'bg-purple-100 text-purple-700 border-purple-200 dark:bg-purple-900/30 dark:text-purple-300 dark:border-purple-800',
            'bg-indigo-100 text-indigo-700 border-indigo-200 dark:bg-indigo-900/30 dark:text-indigo-300 dark:border-indigo-800',
            'bg-teal-100 text-teal-700 border-teal-200 dark:bg-teal-900/30 dark:text-teal-300 dark:border-teal-800',
            'bg-yellow-100 text-yellow-700 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-300 dark:border-yellow-800',
            'bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-300 dark:border-red-800',
        ];

        const getColorForCity = (city) => {
            if (!city) return 'bg-gray-100 text-gray-700 border-gray-200 dark:bg-gray-800 dark:text-gray-300 dark:border-gray-700';
            let hash = 0;
            for (let i = 0; i < city.length; i++) hash = city.charCodeAt(i) + ((hash << 5) - hash);
            return CITY_COLORS[Math.abs(hash) % CITY_COLORS.length];
        };

        // --- HARİTA BİLEŞENİ ---
        const MapComponent = ({ items }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef([]);

            useEffect(() => {
                if (!mapRef.current) return;
                if (!mapInstanceRef.current) {
                    mapInstanceRef.current = L.map(mapRef.current).setView([39.92, 32.85], 5);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(mapInstanceRef.current);
                }
                markersRef.current.forEach(marker => marker.remove());
                markersRef.current = [];
                const bounds = L.latLngBounds();
                let hasMarkers = false;
                items.forEach(item => {
                    if (item.lat && item.lon) {
                        const marker = L.marker([item.lat, item.lon]).bindPopup(`<b>${item.text}</b><br>${item.city || item.location || ''}`).addTo(mapInstanceRef.current);
                        markersRef.current.push(marker);
                        bounds.extend([item.lat, item.lon]);
                        hasMarkers = true;
                    }
                });
                if (hasMarkers) mapInstanceRef.current.fitBounds(bounds, { padding: [50, 50] });
            }, [items]);
            return <div ref={mapRef} id="map-container" className="h-full w-full rounded-xl z-0"></div>;
        };

        function TravelPlanner() {
            const [view, setView] = useState('home');
            const [homeTab, setHomeTab] = useState('actions');
            const [listId, setListId] = useState('');
            const [listData, setListData] = useState({ title: '', items: [], theme: 'emerald', participants: {}, coverImage: '' });
            const [joinCode, setJoinCode] = useState('');
            const [newItemText, setNewItemText] = useState('');
            const [newItemLocation, setNewItemLocation] = useState('');
            const [error, setError] = useState('');
            const [copySuccess, setCopySuccess] = useState(false);
            const [user, setUser] = useState(null);
            const [isOnline, setIsOnline] = useState(true);
            const [history, setHistory] = useState([]);
            const [showSettings, setShowSettings] = useState(false);
            const [editTitle, setEditTitle] = useState('');
            const [editCover, setEditCover] = useState('');
            const [addingItem, setAddingItem] = useState(false);
            const [darkMode, setDarkMode] = useState(() => { return localStorage.getItem('theme') === 'dark'; });
            const [layout, setLayout] = useState('list');
            const [search, setSearch] = useState('');
            const [activeListTab, setActiveListTab] = useState('planned');
            const [activeCommentId, setActiveCommentId] = useState(null);
            const [sortOption, setSortOption] = useState('date');
            const [sortDirection, setSortDirection] = useState('desc');
            const dragItem = useRef(null);
            const dragOverItem = useRef(null);

            useEffect(() => {
                if (darkMode) { document.documentElement.classList.add('dark'); localStorage.setItem('theme', 'dark'); } else { document.documentElement.classList.remove('dark'); localStorage.setItem('theme', 'light'); }
            }, [darkMode]);

            useEffect(() => {
                if (!firebase.apps.length) { try { firebase.initializeApp(firebaseConfig); } catch (e) { setError("Bağlantı ayarları hatalı."); setIsOnline(false); } }
                const unsubscribe = firebase.auth().onAuthStateChanged((currentUser) => {
                    if (currentUser) { 
                        setUser(currentUser); setError(''); 
                        if (!currentUser.isAnonymous) {
                            const db = firebase.firestore();
                            db.collection('users').doc(currentUser.uid).get().then(doc => {
                                if (doc.exists && doc.data().history) {
                                    setHistory(doc.data().history);
                                    localStorage.setItem('travel_history', JSON.stringify(doc.data().history));
                                }
                            });
                        }
                    } else { signInAnonymously(); }
                });
                const savedHistory = JSON.parse(localStorage.getItem('travel_history') || '[]');
                setHistory(savedHistory);
                const lastList = localStorage.getItem('last_travel_list');
                if (lastList) { setListId(lastList); setView('list'); }
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!listId || view !== 'list' || !user) return;
                const db = firebase.firestore();
                const docRef = db.collection('travel_lists').doc(listId);
                const unsubscribe = docRef.onSnapshot((docSnap) => {
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        setListData({ ...data, theme: data.theme || 'emerald', participants: data.participants || {}, coverImage: data.coverImage || '' });
                        setError('');
                        setEditTitle(data.title);
                        setEditCover(data.coverImage || '');
                        addToHistory(listId, data.title);
                    } else {
                        setError('Bu kodla bir liste bulunamadı.');
                        if (listId === localStorage.getItem('last_travel_list')) { localStorage.removeItem('last_travel_list'); setView('home'); }
                    }
                }, (err) => { console.error(err); setError('Veriye erişilemedi.'); });
                return () => unsubscribe();
            }, [listId, view, user]);

            const addToHistory = async (id, title) => {
                if (!title) return;
                let currentHistory = JSON.parse(localStorage.getItem('travel_history') || '[]');
                currentHistory = currentHistory.filter(h => h.id !== id);
                currentHistory.unshift({ id, title, date: new Date().toISOString() });
                localStorage.setItem('travel_history', JSON.stringify(currentHistory));
                setHistory(currentHistory);
                if (user && !user.isAnonymous) { try { await firebase.firestore().collection('users').doc(user.uid).set({ history: currentHistory }, { merge: true }); } catch (e) {} }
            };

            const removeFromHistory = async (id) => {
                let currentHistory = JSON.parse(localStorage.getItem('travel_history') || '[]');
                currentHistory = currentHistory.filter(h => h.id !== id);
                localStorage.setItem('travel_history', JSON.stringify(currentHistory));
                setHistory(currentHistory);
                if (user && !user.isAnonymous) { try { await firebase.firestore().collection('users').doc(user.uid).set({ history: currentHistory }, { merge: true }); } catch (e) {} }
            };

            const signInAnonymously = () => { firebase.auth().signInAnonymously().catch(() => {}); };
            const signInWithGoogle = () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                firebase.auth().signInWithPopup(provider).then(() => setError("")).catch((error) => { setError("Giriş Hatası: " + error.message); });
            };
            const logout = () => { firebase.auth().signOut().then(() => { localStorage.removeItem('last_travel_list'); setView('home'); setListId(''); }); };
            const generateCode = () => { const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let result = ''; for (let i = 0; i < 6; i++) { result += chars.charAt(Math.floor(Math.random() * chars.length)); } return result; };

            const createList = async () => {
                if (!newItemText.trim()) return;
                const newCode = generateCode();
                const newList = { title: newItemText, createdAt: new Date().toISOString(), createdBy: user ? user.uid : 'anonymous', theme: 'emerald', participants: { [user.uid]: { name: user.displayName || 'Yönetici', photo: user.photoURL } }, items: [] };
                try { await firebase.firestore().collection('travel_lists').doc(newCode).set(newList); setListId(newCode); localStorage.setItem('last_travel_list', newCode); setNewItemText(''); setView('list'); } catch (e) { setError("Oluşturulamadı: " + e.message); }
            };

            const joinList = async (codeOverride) => {
                const code = (codeOverride || joinCode).toUpperCase().trim();
                if (!code) return;
                if (user) { try { const db = firebase.firestore(); await db.collection('travel_lists').doc(code).update({ [`participants.${user.uid}`]: { name: user.displayName || 'Misafir', photo: user.photoURL } }); } catch (e) {} }
                setListId(code); localStorage.setItem('last_travel_list', code); setView('list');
            };

            const fetchMeta = async (url) => {
                if (!url.startsWith('http')) return null;
                try { const response = await fetch(`https://api.microlink.io/?url=${encodeURIComponent(url)}&palette=true`); const data = await response.json(); return data.data?.image?.url || null; } catch (e) { return null; }
            };

            const fetchLocationDetails = async (query) => {
                if (!query) return { coords: null, city: null };
                try {
                    const coordsMatch = query.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
                    if (coordsMatch) {
                        const lat = parseFloat(coordsMatch[1]);
                        const lon = parseFloat(coordsMatch[2]);
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                        const data = await response.json();
                        const city = data.address.city || data.address.town || data.address.province || data.address.state || "Bilinmiyor";
                        return { coords: { lat, lon }, city };
                    }
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1`);
                    const data = await response.json();
                    if (data && data.length > 0) {
                        const addr = data[0].address;
                        const city = addr.city || addr.town || addr.province || addr.state || "Bilinmiyor";
                        return { coords: { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) }, city };
                    }
                } catch (e) { console.log("Detaylar bulunamadı", e); }
                return { coords: null, city: null };
            };

            const addItem = async () => {
                if (!newItemText.trim()) return;
                setAddingItem(true);
                let fetchedImage = null;
                let locationDetails = { coords: null, city: null };

                if (newItemLocation) {
                    if (newItemLocation.startsWith('http')) { fetchedImage = await fetchMeta(newItemLocation); }
                    locationDetails = await fetchLocationDetails(newItemLocation) || await fetchLocationDetails(newItemText);
                } else {
                    locationDetails = await fetchLocationDetails(newItemText);
                }

                const newItem = {
                    id: Date.now().toString(),
                    text: newItemText,
                    location: newItemLocation,
                    image: fetchedImage,
                    lat: locationDetails.coords?.lat || null,
                    lon: locationDetails.coords?.lon || null,
                    city: locationDetails.city || null,
                    completed: false,
                    addedBy: user.uid,
                    addedByName: user.displayName || 'Misafir',
                    addedByPhoto: user.photoURL || null,
                    addedAt: new Date().toISOString(),
                    comment: ''
                };
                const updatedItems = [...(listData.items || []), newItem];
                try { await firebase.firestore().collection('travel_lists').doc(listId).update({ items: updatedItems }); setNewItemText(''); setNewItemLocation(''); } catch (e) { setError("Ekleme hatası: " + e.message); } finally { setAddingItem(false); }
            };

            const toggleItem = async (itemId) => {
                const updatedItems = listData.items.map(item => item.id === itemId ? { ...item, completed: !item.completed } : item);
                await firebase.firestore().collection('travel_lists').doc(listId).update({ items: updatedItems });
            };
            const deleteItem = async (itemId) => {
                const updatedItems = listData.items.filter(item => item.id !== itemId);
                await firebase.firestore().collection('travel_lists').doc(listId).update({ items: updatedItems });
            };
            const updateComment = async (itemId, newComment) => {
                const updatedItems = listData.items.map(item => item.id === itemId ? { ...item, comment: newComment } : item);
                await firebase.firestore().collection('travel_lists').doc(listId).update({ items: updatedItems });
            };
            const handleSortDrag = async () => {
                if (dragItem.current === null || dragOverItem.current === null) return;
                const _items = [...listData.items];
                const activeItems = _items.filter(i => !i.completed);
                const completedItems = _items.filter(i => i.completed);
                const draggedItemContent = activeItems[dragItem.current];
                activeItems.splice(dragItem.current, 1);
                activeItems.splice(dragOverItem.current, 0, draggedItemContent);
                const finalItems = [...activeItems, ...completedItems];
                dragItem.current = null;
                dragOverItem.current = null;
                await firebase.firestore().collection('travel_lists').doc(listId).update({ items: finalItems });
            };
            const updateListTitle = async () => { if(!editTitle.trim()) return; await firebase.firestore().collection('travel_lists').doc(listId).update({ title: editTitle }); };
            const updateListCover = async () => {
                let finalCoverUrl = editCover.trim();
                if (finalCoverUrl && !finalCoverUrl.startsWith('http')) { finalCoverUrl = `https://image.pollinations.ai/prompt/scenic%20travel%20photo%20of%20${encodeURIComponent(finalCoverUrl)}?width=1200&height=600&nologo=true`; }
                await firebase.firestore().collection('travel_lists').doc(listId).update({ coverImage: finalCoverUrl });
            };
            const changeTheme = async (themeKey) => { await firebase.firestore().collection('travel_lists').doc(listId).update({ theme: themeKey }); };
            const deleteList = async () => { if(confirm('Bu listeyi tamamen silmek istediğinize emin misiniz?')) { await firebase.firestore().collection('travel_lists').doc(listId).delete(); removeFromHistory(listId); exitList(); } };
            const removeParticipant = async (uid) => { if(confirm('Bu kişiyi listeden çıkarmak istiyor musunuz?')) { await firebase.firestore().collection('travel_lists').doc(listId).update({ [`participants.${uid}`]: firebase.firestore.FieldValue.delete() }); } };
            const leaveList = async () => { if(confirm('Bu listeden ayrılmak istiyor musunuz?')) { if (user && listData.participants[user.uid]) { await firebase.firestore().collection('travel_lists').doc(listId).update({ [`participants.${user.uid}`]: firebase.firestore.FieldValue.delete() }); } removeFromHistory(listId); exitList(); } };
            const copyCodeToClipboard = () => { navigator.clipboard.writeText(listId).then(() => { setCopySuccess(true); setTimeout(() => setCopySuccess(false), 2000); }); };
            const exitList = () => { localStorage.removeItem('last_travel_list'); setView('home'); setListId(''); setShowSettings(false); };

            const toggleSort = () => {
                if (sortOption === 'date') setSortOption('name');
                else if (sortOption === 'name') setSortOption('city');
                else setSortOption('date');
            };

            const toggleSortDirection = () => { setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc'); };

            const currentTheme = THEMES[listData.theme || 'emerald'];

            const sortedItems = useMemo(() => {
                let items = (listData.items || []).filter(item => item.text.toLowerCase().includes(search.toLowerCase())).filter(item => activeListTab === 'planned' ? !item.completed : item.completed);
                
                return items.sort((a, b) => {
                    let valA, valB;
                    if (sortOption === 'date') {
                        valA = new Date(a.addedAt).getTime();
                        valB = new Date(b.addedAt).getTime();
                    } else if (sortOption === 'name') {
                        valA = a.text.toLowerCase();
                        valB = b.text.toLowerCase();
                    } else if (sortOption === 'city') {
                        valA = (a.city || '').toLowerCase();
                        valB = (b.city || '').toLowerCase();
                    }

                    if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }, [listData.items, search, activeListTab, sortOption, sortDirection]);

            if (!user && isOnline) return <div className="flex items-center justify-center h-screen bg-slate-50 dark:bg-slate-900"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600"></div></div>;

            if (view === 'home') {
                return (
                    <div className="min-h-screen bg-slate-50 dark:bg-slate-900 flex flex-col font-sans animate-fade-in transition-colors duration-300">
                        <div className="bg-emerald-600 p-8 pb-12 rounded-b-[2.5rem] shadow-lg relative z-10">
                            <div className="absolute top-4 right-4 flex items-center gap-2">
                                <button onClick={() => setDarkMode(!darkMode)} className="text-white/80 hover:text-white p-1">{darkMode ? <Icons.Sun size={20}/> : <Icons.Moon size={20}/>}</button>
                                {user && !user.isAnonymous ? (<><img src={user.photoURL} className="w-8 h-8 rounded-full border-2 border-white" alt="Profil" /><button onClick={logout} className="text-xs text-white/80 hover:text-white underline">Çıkış</button></>) : (<button onClick={signInWithGoogle} className="bg-white text-gray-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1 shadow-sm hover:bg-gray-100 transition-colors"><Icons.Google className="w-3 h-3"/> Giriş Yap</button>)}
                            </div>
                            <div className="text-center"><Icons.Map className="w-16 h-16 text-white mx-auto mb-4 opacity-90" /><h1 className="text-3xl font-bold text-white mb-2">Gezgin</h1><p className="text-emerald-100">{user && !user.isAnonymous ? `Merhaba, ${user.displayName.split(' ')[0]}!` : 'Ortak Seyahat Planlayıcı'}</p></div>
                        </div>
                        <div className="flex-1 px-6 -mt-8 pb-24 max-w-md mx-auto w-full relative z-20">
                            <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-xl overflow-hidden min-h-[400px]">
                                <div className="flex border-b border-gray-100 dark:border-slate-700">
                                    <button onClick={() => setHomeTab('actions')} className={`flex-1 py-4 text-sm font-semibold flex items-center justify-center gap-2 transition-colors ${homeTab === 'actions' ? 'text-emerald-600 border-b-2 border-emerald-600 bg-emerald-50/50 dark:bg-emerald-900/20' : 'text-gray-400 hover:text-gray-600 dark:text-gray-500'}`}><Icons.Home size={18}/> Ana Sayfa</button>
                                    <button onClick={() => setHomeTab('mylists')} className={`flex-1 py-4 text-sm font-semibold flex items-center justify-center gap-2 transition-colors ${homeTab === 'mylists' ? 'text-emerald-600 border-b-2 border-emerald-600 bg-emerald-50/50 dark:bg-emerald-900/20' : 'text-gray-400 hover:text-gray-600 dark:text-gray-500'}`}><Icons.List size={18}/> Listelerim</button>
                                </div>
                                <div className="p-6">
                                    {homeTab === 'actions' ? (
                                        <div className="space-y-8 animate-fade-in">
                                            <div className="space-y-4"><h2 className="text-lg font-semibold text-gray-700 dark:text-gray-200 flex items-center gap-2"><Icons.Plus className="w-5 h-5 text-emerald-600" /> Yeni Liste Oluştur</h2><div className="flex flex-col gap-3"><input type="text" placeholder="Örn: İtalya" className="w-full px-4 py-3 border border-gray-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl focus:ring-2 focus:ring-emerald-500 focus:outline-none" value={newItemText} onChange={(e) => setNewItemText(e.target.value)} /><button onClick={createList} disabled={!newItemText.trim()} className="w-full bg-emerald-600 hover:bg-emerald-700 disabled:opacity-50 text-white px-6 py-3 rounded-xl font-medium transition-colors">Oluştur</button></div></div>
                                            <div className="relative"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-200 dark:border-slate-700"></div></div><div className="relative flex justify-center text-sm"><span className="px-2 bg-white dark:bg-slate-800 text-gray-500">veya</span></div></div>
                                            <div className="space-y-4"><h2 className="text-lg font-semibold text-gray-700 dark:text-gray-200 flex items-center gap-2"><Icons.Users className="w-5 h-5 text-blue-600" /> Listeye Katıl</h2><div className="flex flex-col gap-3"><input type="text" placeholder="KOD" className="w-full px-4 py-3 border border-gray-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none uppercase" value={joinCode} onChange={(e) => setJoinCode(e.target.value)} /><button onClick={() => joinList()} disabled={!joinCode.trim()} className="w-full bg-blue-600 hover:bg-blue-700 disabled:opacity-50 text-white px-6 py-3 rounded-xl font-medium transition-colors">Katıl</button></div></div>
                                        </div>
                                    ) : (
                                        <div className="space-y-3 animate-fade-in">
                                            {history.length > 0 ? history.map((h) => (<button key={h.id} onClick={() => joinList(h.id)} className="w-full bg-white dark:bg-slate-700 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-slate-600 flex items-center justify-between hover:shadow-md transition-all group"><div className="flex items-center gap-3"><div className="bg-emerald-100 dark:bg-emerald-900 p-2 rounded-lg text-emerald-600 dark:text-emerald-400 group-hover:bg-emerald-600 group-hover:text-white transition-colors"><Icons.MapPin size={18}/></div><div className="text-left"><div className="font-medium text-gray-800 dark:text-gray-200">{h.title || 'İsimsiz Liste'}</div><div className="text-xs text-gray-400 font-mono tracking-wider">{h.id}</div></div></div><Icons.ArrowRight size={16} className="text-gray-300 group-hover:text-emerald-500"/></button>)) : <div className="text-center py-10 text-gray-400"><Icons.List className="w-12 h-12 mx-auto mb-2 opacity-20"/><p>Henüz kayıtlı bir listen yok.</p></div>}
                                        </div>
                                    )}
                                </div>
                            </div>
                            {error && <div className="mt-4 text-red-500 bg-red-50 dark:bg-red-900/30 dark:text-red-300 px-4 py-2 rounded-lg border border-red-100 dark:border-red-900 text-sm max-w-md text-center font-semibold">{error}</div>}
                        </div>
                    </div>
                );
            }

            const completedCount = listData.items?.filter(i => i.completed).length || 0;
            const totalCount = listData.items?.length || 0;
            const progress = totalCount === 0 ? 0 : Math.round((completedCount / totalCount) * 100);
            const isOwner = listData.createdBy === user.uid;

            return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-900 font-sans animate-fade-in pb-safe transition-colors duration-300">
                    {/* SETTINGS MODAL */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-md p-6 shadow-2xl animate-fade-in overflow-y-auto max-h-[90vh]">
                                <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold text-gray-800 dark:text-white flex items-center gap-2"><Icons.Settings size={24}/> Liste Ayarları</h2><button onClick={() => setShowSettings(false)} className="p-2 bg-gray-100 dark:bg-slate-700 rounded-full hover:bg-gray-200 dark:hover:bg-slate-600 dark:text-white"><Icons.X size={20}/></button></div>
                                <div className="space-y-6 text-gray-800 dark:text-gray-200">
                                    <div><label className="block text-sm font-medium mb-2">Liste İsmi</label><div className="flex gap-2"><input type="text" value={editTitle} onChange={(e) => setEditTitle(e.target.value)} className="flex-1 px-3 py-2 border dark:border-slate-600 dark:bg-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/><button onClick={updateListTitle} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Kaydet</button></div></div>
                                    <div><label className="block text-sm font-medium mb-2">Kapak Görseli (URL veya Kelime)</label><div className="flex gap-2"><input type="text" placeholder="Örn: Paris, Doğa..." value={editCover} onChange={(e) => setEditCover(e.target.value)} className="flex-1 px-3 py-2 border dark:border-slate-600 dark:bg-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/><button onClick={updateListCover} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Değiştir</button></div><p className="text-xs text-gray-500 mt-1">İpucu: Bir kelime yazarsanız yapay zeka sizin için resim oluşturur!</p></div>
                                    <div><label className="block text-sm font-medium mb-2">Tema Rengi</label><div className="flex gap-3 overflow-x-auto pb-2">{Object.entries(THEMES).map(([key, val]) => (<button key={key} onClick={() => changeTheme(key)} className={`w-10 h-10 rounded-full ${val.bg} border-2 ${listData.theme === key ? 'border-gray-800 scale-110' : 'border-transparent'} shadow-sm transition-all`} title={val.name}></button>))}</div></div>
                                    <div><label className="block text-sm font-medium mb-2">Katılımcılar</label><div className="space-y-2 max-h-40 overflow-y-auto border dark:border-slate-600 rounded-lg p-2 bg-gray-50 dark:bg-slate-700">{Object.entries(listData.participants || {}).map(([uid, p]) => (<div key={uid} className="flex items-center justify-between p-2 bg-white dark:bg-slate-600 rounded-md shadow-sm"><div className="flex items-center gap-2">{p.photo ? <img src={p.photo} className="w-8 h-8 rounded-full"/> : <div className="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-xs">{p.name?.[0]}</div>}<span className="text-sm font-medium">{p.name}</span>{uid === listData.createdBy && <span className="text-xs bg-yellow-100 text-yellow-800 px-1.5 py-0.5 rounded">Yönetici</span>}</div>{isOwner && uid !== user.uid && (<button onClick={() => removeParticipant(uid)} className="text-red-500 hover:bg-red-50 p-1 rounded"><Icons.Trash2 size={16}/></button>)}</div>))}</div></div>
                                    <hr className="border-gray-200 dark:border-slate-700"/>
                                    <div className="space-y-3">{!isOwner && (<button onClick={leaveList} className="w-full py-3 rounded-xl border border-red-200 text-red-600 font-medium hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors flex items-center justify-center gap-2"><Icons.LogOut size={18}/> Listeden Ayrıl</button>)}{isOwner && (<button onClick={deleteList} className="w-full py-3 rounded-xl bg-red-100 dark:bg-red-900/30 text-red-600 font-medium hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors flex items-center justify-center gap-2"><Icons.Trash2 size={18}/> Listeyi Kalıcı Sil</button>)}</div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className={`text-white pb-40 rounded-b-[2.5rem] shadow-lg sticky top-0 z-10 transition-colors duration-500 pt-safe relative overflow-hidden`}>
                        {listData.coverImage ? (<div className="absolute inset-0 z-0"><img src={listData.coverImage} className="w-full h-full object-cover" /><div className="absolute inset-0 bg-black/50 backdrop-blur-sm"></div></div>) : (<div className={`absolute inset-0 z-0 ${currentTheme.bg}`}></div>)}
                        
                        <div className="max-w-3xl mx-auto p-6 relative z-10">
                            <div className="flex justify-between items-start mb-6">
                                <button onClick={exitList} className="p-2 bg-black/20 hover:bg-black/30 rounded-lg transition-colors flex items-center gap-2 text-sm backdrop-blur-sm"><Icons.ArrowRight size={16} className="rotate-180" /> Geri</button>
                                <div className="flex gap-2">
                                    <button onClick={() => setDarkMode(!darkMode)} className="p-2 bg-black/20 hover:bg-black/30 rounded-full backdrop-blur-sm border border-white/20">{darkMode ? <Icons.Sun size={20}/> : <Icons.Moon size={20}/>}</button>
                                    <button onClick={copyCodeToClipboard} className="flex items-center gap-2 bg-black/20 hover:bg-black/30 px-4 py-2 rounded-full backdrop-blur-sm transition-all border border-white/20"><span className="font-mono text-lg font-bold tracking-wider">{listId}</span>{copySuccess ? <span className="text-xs">Kopyalandı!</span> : <Icons.Copy size={16} />}</button>
                                    <button onClick={() => setShowSettings(true)} className="p-2 bg-black/20 hover:bg-black/30 rounded-full backdrop-blur-sm border border-white/20"><Icons.Settings size={20} /></button>
                                </div>
                            </div>
                            <h1 className="text-3xl md:text-4xl font-bold mb-2">{listData.title}</h1>
                            
                            {/* SEARCH & SORT */}
                            <div className="flex flex-col gap-2 mt-4 bg-white/10 p-2 rounded-xl backdrop-blur-sm">
                                <div className="flex gap-2">
                                    <div className="flex-1 flex items-center gap-2 px-3 bg-white/20 rounded-lg"><Icons.Search size={18} className="text-white/70"/><input type="text" placeholder="Ara..." className="bg-transparent border-none outline-none text-white placeholder-white/60 w-full py-2" value={search} onChange={(e) => setSearch(e.target.value)}/></div>
                                    <button onClick={() => setLayout('list')} className={`p-2 rounded-lg transition-colors ${layout === 'list' ? 'bg-white text-gray-800' : 'text-white hover:bg-white/20'}`}><Icons.List size={20}/></button>
                                    <button onClick={() => setLayout('grid')} className={`p-2 rounded-lg transition-colors ${layout === 'grid' ? 'bg-white text-gray-800' : 'text-white hover:bg-white/20'}`}><Icons.Grid size={20}/></button>
                                    <button onClick={() => setLayout('map')} className={`p-2 rounded-lg transition-colors ${layout === 'map' ? 'bg-white text-gray-800' : 'text-white hover:bg-white/20'}`}><Icons.MapIcon size={20}/></button>
                                </div>
                                <div className="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                                    <button onClick={toggleSort} className="flex items-center gap-1 px-3 py-1.5 rounded-lg bg-black/20 hover:bg-black/30 text-xs font-medium whitespace-nowrap"><span className="opacity-70">Sırala:</span> {sortOption === 'date' ? 'Tarih' : sortOption === 'name' ? 'İsim' : 'Şehir'}</button>
                                    <button onClick={toggleSortDirection} className="p-1.5 rounded-lg bg-black/20 hover:bg-black/30 text-xs">{sortDirection === 'asc' ? <Icons.SortAsc size={14}/> : <Icons.SortDesc size={14}/>}</button>
                                </div>
                            </div>
                        </div>
                        <div className="absolute bottom-0 w-full px-6 pb-2 relative z-10"><div className="max-w-3xl mx-auto flex"><button onClick={() => setActiveListTab('planned')} className={`flex-1 pb-3 text-sm font-bold border-b-4 transition-all ${activeListTab === 'planned' ? 'border-white text-white' : 'border-transparent text-white/60'}`}>GİDİLECEKLER</button><button onClick={() => setActiveListTab('visited')} className={`flex-1 pb-3 text-sm font-bold border-b-4 transition-all ${activeListTab === 'visited' ? 'border-white text-white' : 'border-transparent text-white/60'}`}>GİDİLENLER</button></div></div>
                    </div>

                    <div className="max-w-3xl mx-auto px-4 -mt-4 pb-10 relative z-20">
                        {/* Map View */}
                        {layout === 'map' ? (
                            <div className="h-[60vh] bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-gray-100 dark:border-slate-700 overflow-hidden relative">
                                <MapComponent items={sortedItems} />
                            </div>
                        ) : (
                            <>
                                {activeListTab === 'planned' && (
                                    <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-lg border border-gray-100 dark:border-slate-700 mb-6">
                                        <div className="flex flex-col gap-3 sm:flex-row">
                                            <div className="flex items-center gap-3 flex-1"><div className={`p-2 ${currentTheme.light} dark:bg-opacity-20 rounded-lg ${currentTheme.text}`}><Icons.Plus size={20} /></div><input type="text" placeholder="Rota ekle..." className="flex-1 bg-transparent focus:outline-none text-lg placeholder-gray-400 dark:placeholder-gray-500 text-gray-800 dark:text-white" value={newItemText} onChange={(e) => setNewItemText(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && addItem()} /></div>
                                            <div className="flex items-center gap-3 pl-12 sm:pl-0 flex-1"><Icons.MapPin size={16} className="text-gray-400" /><input type="text" placeholder="Konum veya Link (Opsiyonel)" className="flex-1 bg-transparent focus:outline-none text-sm placeholder-gray-400 dark:placeholder-gray-500 text-gray-600 dark:text-gray-300" value={newItemLocation} onChange={(e) => setNewItemLocation(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && addItem()} /><button onClick={addItem} disabled={!newItemText.trim() || addingItem} className={`${currentTheme.bg} hover:opacity-90 text-white p-2 rounded-lg transition-colors disabled:opacity-50`}>{addingItem ? <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> : <Icons.ArrowRight size={20} />}</button></div>
                                        </div>
                                    </div>
                                )}

                                <div className={layout === 'grid' ? 'grid grid-cols-2 gap-3' : 'space-y-3'}>
                                    {sortedItems.map((item, index) => (
                                        <div key={item.id} draggable={activeListTab === 'planned' && layout === 'list'} onDragStart={() => (dragItem.current = index)} onDragEnter={() => (dragOverItem.current = index)} onDragEnd={handleSortDrag} onDragOver={(e) => e.preventDefault()} className={`group bg-white dark:bg-slate-800 p-3 rounded-2xl shadow-sm border border-gray-100 dark:border-slate-700 flex ${layout === 'grid' ? 'flex-col' : 'gap-4'} transition-all hover:shadow-md relative`}>
                                            {layout === 'list' && activeListTab === 'planned' && (<div className="absolute left-1 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-30 cursor-grab active:cursor-grabbing p-1"><Icons.Drag size={14}/></div>)}
                                            {item.image && (<div className={`${layout === 'grid' ? 'w-full h-32' : 'w-24 h-24'} flex-shrink-0 rounded-xl overflow-hidden bg-gray-100 dark:bg-slate-700 shadow-inner`}><img src={item.image} alt={item.text} className="w-full h-full object-cover" onError={(e) => e.target.style.display = 'none'} /></div>)}
                                            <div className="flex-1 flex flex-col justify-center min-w-0 gap-2">
                                                <div className="flex items-start gap-3"><button onClick={() => toggleItem(item.id)} className={`flex-shrink-0 transition-colors pt-1 ${item.completed ? currentTheme.text : 'text-gray-300 hover:' + currentTheme.text}`}>{item.completed ? <Icons.CheckSquare size={22} /> : <Icons.Square size={22} />}</button>
                                                    <div className="flex-1 min-w-0">
                                                        <h3 className={`text-lg font-bold leading-tight dark:text-white ${item.completed ? 'text-gray-500 line-through dark:text-gray-500' : 'text-gray-800'}`}>{item.text}</h3>
                                                        {item.city && item.city !== "Bilinmiyor" && (
                                                            <span className={`inline-block mt-1 px-2 py-0.5 text-[10px] font-bold rounded border ${getColorForCity(item.city)}`}>
                                                                {item.city.toUpperCase()}
                                                            </span>
                                                        )}
                                                    </div>
                                                    <button onClick={() => deleteItem(item.id)} className="text-gray-300 hover:text-red-500 transition-colors p-1"><Icons.Trash2 size={18} /></button></div>
                                                <div className="flex flex-wrap items-center gap-3 pl-8 sm:pl-0"> 
                                                {item.location && (<a href={item.location.startsWith('http') ? item.location : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`} target="_blank" rel="noopener noreferrer" className={`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-semibold ${currentTheme.light} dark:bg-slate-700 ${currentTheme.text} dark:text-emerald-400 hover:opacity-80 transition-opacity`}><Icons.MapPin size={14} /> Bağlantıya Git</a>)}
                                                {item.addedByName && (<div className="flex items-center gap-1.5 text-xs text-gray-400">{item.addedByPhoto ? <img src={item.addedByPhoto} className="w-5 h-5 rounded-full" /> : <div className="w-5 h-5 rounded-full bg-gray-200 flex items-center justify-center">{item.addedByName[0]}</div>}</div>)}
                                                <button onClick={() => setActiveCommentId(activeCommentId === item.id ? null : item.id)} className={`text-xs flex items-center gap-1 ${item.comment ? currentTheme.text : 'text-gray-400 hover:text-gray-600'}`}><Icons.MessageSquare size={14}/> {item.comment ? 'Notu Gör' : 'Not Ekle'}</button>
                                                </div>
                                                {(activeCommentId === item.id || item.comment) && (<div className={`mt-2 p-2 bg-gray-50 dark:bg-slate-700 rounded-lg text-sm ${activeCommentId !== item.id && 'hidden'}`}><textarea className="w-full bg-transparent outline-none resize-none text-gray-700 dark:text-gray-200" placeholder="Notunuzu buraya yazın..." rows="2" defaultValue={item.comment} onBlur={(e) => updateComment(item.id, e.target.value)}></textarea></div>)}
                                            </div>
                                        </div>
                                    ))}
                                    {sortedItems.length === 0 && <div className="text-center py-12 text-gray-400 dark:text-slate-600"><p>{activeListTab === 'planned' ? 'Planlanmış rota yok.' : 'Henüz gidilen bir yer yok.'}</p></div>}
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TravelPlanner />);
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js').catch(() => {});
            });
        }
    </script>
</body>
</html>
