<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gezgin</title>
    
    <!-- PWA Ayarları -->
    <meta name="theme-color" content="#059669">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 750: '#293548', 850: '#172033', 950: '#0b1121' }
                    }
                }
            }
        }
    </script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        input { font-size: 16px !important; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* Drag & Drop Styles */
        .dragging { opacity: 0.5; transform: scale(0.95); }
        .drag-over { border: 2px dashed #10b981; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 select-none transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyDTn2eXJbEiCnr-nwUlR7P2oDLX-KowCtQ",
            authDomain: "gezginapp-70b69.firebaseapp.com",
            projectId: "gezginapp-70b69",
            storageBucket: "gezginapp-70b69.firebasestorage.app",
            messagingSenderId: "120226629154",
            appId: "1:120226629154:web:147621c900c5a9f0e06c7b"
        };

        const Icons = {
            MapPin: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
            CheckSquare: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>,
            Square: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/></svg>,
            Plus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Users: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            ArrowRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            LogOut: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Map: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="21"/><line x1="15" x2="15" y1="3" y2="21"/></svg>,
            Copy: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            Trash2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            History: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>,
            Settings: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
            Edit: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>,
            Google: (props) => <svg {...props} viewBox="0 0 24 24" width="24" height="24" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>,
            Home: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            List: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            Image: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            Grid: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>,
            Search: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Moon: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
            Sun: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            MessageSquare: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            Drag: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>
        };

        const THEMES = {
            emerald: { name: 'Yeşil', bg: 'bg-emerald-600', text: 'text-emerald-600', light: 'bg-emerald-100', from: 'from-emerald-400', to: 'to-emerald-600', shadow: 'shadow-emerald-200' },
            purple: { name: 'Mor', bg: 'bg-purple-600', text: 'text-purple-600', light: 'bg-purple-100', from: 'from-purple-400', to: 'to-purple-600', shadow: 'shadow-purple-200' },
            blue: { name: 'Mavi', bg: 'bg-blue-600', text: 'text-blue-600', light: 'bg-blue-100', from: 'from-blue-400', to: 'to-blue-600', shadow: 'shadow-blue-200' },
            rose: { name: 'Gül', bg: 'bg-rose-600', text: 'text-rose-600', light: 'bg-rose-100', from: 'from-rose-400', to: 'to-rose-600', shadow: 'shadow-rose-200' },
            amber: { name: 'Turuncu', bg: 'bg-amber-500', text: 'text-amber-600', light: 'bg-amber-100', from: 'from-amber-400', to: 'to-amber-600', shadow: 'shadow-amber-200' },
            slate: { name: 'Siyah', bg: 'bg-slate-700', text: 'text-slate-700', light: 'bg-slate-200', from: 'from-slate-500', to: 'to-slate-800', shadow: 'shadow-slate-300' }
        };

        function TravelPlanner() {
            const [view, setView] = useState('home');
            const [homeTab, setHomeTab] = useState('actions');
            const [listId, setListId] = useState('');
            const [listData, setListData] = useState({ title: '', items: [], theme: 'emerald', participants: {} });
            const [joinCode, setJoinCode] = useState('');
            const [newItemText, setNewItemText] = useState('');
            const [newItemLocation, setNewItemLocation] = useState('');
            const [error, setError] = useState('');
            const [copySuccess, setCopySuccess] = useState(false);
            const [user, setUser] = useState(null);
            const [isOnline, setIsOnline] = useState(true);
            const [history, setHistory] = useState([]);
            const [showSettings, setShowSettings] = useState(false);
            const [editTitle, setEditTitle] = useState('');
            const [addingItem, setAddingItem] = useState(false);
            
            // New States
            const [darkMode, setDarkMode] = useState(() => {
                return localStorage.getItem('theme') === 'dark';
            });
            const [layout, setLayout] = useState('list'); // 'list' | 'grid'
            const [search, setSearch] = useState('');
            const [activeListTab, setActiveListTab] = useState('planned'); // 'planned' | 'visited'
            const [activeCommentId, setActiveCommentId] = useState(null);
            
            // Drag Refs
            const dragItem = useRef(null);
            const dragOverItem = useRef(null);

            // Dark Mode Effect
            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            }, [darkMode]);

            useEffect(() => {
                if (!firebase.apps.length) {
                    try { firebase.initializeApp(firebaseConfig); } catch (e) { setError("Bağlantı ayarları hatalı."); setIsOnline(false); }
                }
                const unsubscribe = firebase.auth().onAuthStateChanged((currentUser) => {
                    if (currentUser) { 
                        setUser(currentUser); 
                        setError(''); 
                        // Cihazlar arası senkronizasyon için Firestore'dan çek
                        if (!currentUser.isAnonymous) {
                            const db = firebase.firestore();
                            db.collection('users').doc(currentUser.uid).get().then(doc => {
                                if (doc.exists && doc.data().history) {
                                    setHistory(doc.data().history);
                                    localStorage.setItem('travel_history', JSON.stringify(doc.data().history));
                                }
                            });
                        }
                    } else { 
                        signInAnonymously(); 
                    }
                });
                
                // Başlangıçta local storage'dan al, sonra Auth tetiklenince üstüne yazar
                const savedHistory = JSON.parse(localStorage.getItem('travel_history') || '[]');
                setHistory(savedHistory);
                
                const lastList = localStorage.getItem('last_travel_list');
                if (lastList) { setListId(lastList); setView('list'); }
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!listId || view !== 'list' || !user) return;
                const db = firebase.firestore();
                const docRef = db.collection('travel_lists').doc(listId);
                const unsubscribe = docRef.onSnapshot((docSnap) => {
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        setListData({ ...data, theme: data.theme || 'emerald', participants: data.participants || {} });
                        setError('');
                        setEditTitle(data.title);
                        // Listeyi açınca geçmişe ekle
                        addToHistory(listId, data.title);
                    } else {
                        setError('Bu kodla bir liste bulunamadı.');
                        if (listId === localStorage.getItem('last_travel_list')) {
                            localStorage.removeItem('last_travel_list');
                            setView('home');
                        }
                    }
                }, (err) => { console.error(err); setError('Veriye erişilemedi.'); });
                return () => unsubscribe();
            }, [listId, view, user]);

            const addToHistory = async (id, title) => {
                if (!title) return;
                let currentHistory = JSON.parse(localStorage.getItem('travel_history') || '[]');
                // Önce listede varsa çıkar (en başa eklemek için)
                currentHistory = currentHistory.filter(h => h.id !== id);
                // Başa ekle
                currentHistory.unshift({ id, title, date: new Date().toISOString() });
                
                // Local'e kaydet
                localStorage.setItem('travel_history', JSON.stringify(currentHistory));
                setHistory(currentHistory);

                // Eğer kullanıcı giriş yapmışsa Cloud'a da kaydet
                if (user && !user.isAnonymous) {
                    try {
                        await firebase.firestore().collection('users').doc(user.uid).set({
                            history: currentHistory
                        }, { merge: true });
                    } catch (e) {
                        console.error("Geçmiş kaydedilemedi", e);
                    }
                }
            };

            const removeFromHistory = async (id) => {
                let currentHistory = JSON.parse(localStorage.getItem('travel_history') || '[]');
                currentHistory = currentHistory.filter(h => h.id !== id);
                
                localStorage.setItem('travel_history', JSON.stringify(currentHistory));
                setHistory(currentHistory);

                if (user && !user.isAnonymous) {
                    try {
                        await firebase.firestore().collection('users').doc(user.uid).set({
                            history: currentHistory
                        }, { merge: true });
                    } catch (e) {}
                }
            };

            const signInAnonymously = () => { firebase.auth().signInAnonymously().catch(() => {}); };
            const signInWithGoogle = () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                firebase.auth().signInWithPopup(provider)
                    .then(() => setError(""))
                    .catch((error) => {
                       setError("Giriş Hatası: " + error.message);
                    });
            };
            const logout = () => {
                firebase.auth().signOut().then(() => { localStorage.removeItem('last_travel_list'); setView('home'); setListId(''); });
            };

            const generateCode = () => {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let result = '';
                for (let i = 0; i < 6; i++) { result += chars.charAt(Math.floor(Math.random() * chars.length)); }
                return result;
            };

            const createList = async () => {
                if (!newItemText.trim()) return;
                const newCode = generateCode();
                const newList = {
                    title: newItemText,
                    createdAt: new Date().toISOString(),
                    createdBy: user ? user.uid : 'anonymous',
                    theme: 'emerald',
                    participants: {
                        [user.uid]: { name: user.displayName || 'Yönetici', photo: user.photoURL }
                    },
                    items: []
                };
                try {
                    await firebase.firestore().collection('travel_lists').doc(newCode).set(newList);
                    setListId(newCode);
                    localStorage.setItem('last_travel_list', newCode);
                    setNewItemText('');
                    setView('list');
                } catch (e) { setError("Oluşturulamadı: " + e.message); }
            };

            const joinList = async (codeOverride) => {
                const code = (codeOverride || joinCode).toUpperCase().trim();
                if (!code) return;
                
                if (user) {
                    try {
                        const db = firebase.firestore();
                        await db.collection('travel_lists').doc(code).update({
                            [`participants.${user.uid}`]: { name: user.displayName || 'Misafir', photo: user.photoURL }
                        });
                    } catch (e) { console.log("Katılımcı eklenemedi veya liste yok"); }
                }

                setListId(code);
                localStorage.setItem('last_travel_list', code);
                setView('list');
            };

            const fetchMeta = async (url) => {
                if (!url.startsWith('http')) return null;
                try {
                    const response = await fetch(`https://api.microlink.io/?url=${encodeURIComponent(url)}&palette=true`);
                    const data = await response.json();
                    return data.data?.image?.url || null;
                } catch (e) { return null; }
            };

            const addItem = async () => {
                if (!newItemText.trim()) return;
                setAddingItem(true);
                let fetchedImage = null;
                if (newItemLocation && newItemLocation.startsWith('http')) {
                    fetchedImage = await fetchMeta(newItemLocation);
                }
                const newItem = {
                    id: Date.now().toString(),
                    text: newItemText,
                    location: newItemLocation,
                    image: fetchedImage,
                    completed: false,
                    addedBy: user.uid,
                    addedByName: user.displayName || 'Misafir',
                    addedByPhoto: user.photoURL || null,
                    addedAt: new Date().toISOString(),
                    comment: ''
                };
                const updatedItems = [...(listData.items || []), newItem];
                try {
                    await firebase.firestore().collection('travel_lists').doc(listId).update({ items: updatedItems });
                    setNewItemText('');
                    setNewItemLocation('');
                } catch (e) { setError("Ekleme hatası: " + e.message); }
                finally { setAddingItem(false); }
            };

            const toggleItem = async (itemId) => {
                const updatedItems = listData.items.map(item => item.id === itemId ? { ...item, completed: !item.completed } : item);
                await firebase.firestore().collection('travel_lists').doc(listId).update({ items: updatedItems });
            };

            const deleteItem = async (itemId) => {
                const updatedItems = listData.items.filter(item => item.id !== itemId);
                await firebase.firestore().collection('travel_lists').doc(listId).update({ items: updatedItems });
            };

            const updateComment = async (itemId, newComment) => {
                const updatedItems = listData.items.map(item => item.id === itemId ? { ...item, comment: newComment } : item);
                await firebase.firestore().collection('travel_lists').doc(listId).update({ items: updatedItems });
            };

            // Drag and Drop Sort
            const handleSort = async () => {
                if (dragItem.current === null || dragOverItem.current === null) return;
                const _items = [...listData.items];
                const activeItems = _items.filter(i => !i.completed); // Only sort planned items
                const completedItems = _items.filter(i => i.completed);
                
                // Get the actual items being moved
                const draggedItemContent = activeItems[dragItem.current];
                
                // Remove dragged item
                activeItems.splice(dragItem.current, 1);
                // Insert at new position
                activeItems.splice(dragOverItem.current, 0, draggedItemContent);
                
                // Merge back
                const finalItems = [...activeItems, ...completedItems];
                
                // Reset
                dragItem.current = null;
                dragOverItem.current = null;

                // Optimistic UI update is handled by local state in complex apps, but here we just update Firestore
                await firebase.firestore().collection('travel_lists').doc(listId).update({ items: finalItems });
            };

            const updateListTitle = async () => {
                if(!editTitle.trim()) return;
                await firebase.firestore().collection('travel_lists').doc(listId).update({ title: editTitle });
            };

            const changeTheme = async (themeKey) => {
                await firebase.firestore().collection('travel_lists').doc(listId).update({ theme: themeKey });
            };

            const deleteList = async () => {
                if(confirm('Bu listeyi tamamen silmek istediğinize emin misiniz?')) {
                    await firebase.firestore().collection('travel_lists').doc(listId).delete();
                    removeFromHistory(listId);
                    exitList();
                }
            };

            const removeParticipant = async (uid) => {
                if(confirm('Bu kişiyi listeden çıkarmak istiyor musunuz?')) {
                     await firebase.firestore().collection('travel_lists').doc(listId).update({
                        [`participants.${uid}`]: firebase.firestore.FieldValue.delete()
                    });
                }
            };

            const leaveList = async () => {
                if(confirm('Bu listeden ayrılmak istiyor musunuz?')) {
                    if (user && listData.participants[user.uid]) {
                        await firebase.firestore().collection('travel_lists').doc(listId).update({
                            [`participants.${user.uid}`]: firebase.firestore.FieldValue.delete()
                        });
                    }
                    removeFromHistory(listId);
                    exitList();
                }
            };

            const copyCodeToClipboard = () => {
                navigator.clipboard.writeText(listId).then(() => {
                    setCopySuccess(true);
                    setTimeout(() => setCopySuccess(false), 2000);
                });
            };

            const exitList = () => {
                localStorage.removeItem('last_travel_list');
                setView('home');
                setListId('');
                setShowSettings(false);
            };

            const currentTheme = THEMES[listData.theme || 'emerald'];

            // Filter items based on search and tab
            const filteredItems = (listData.items || [])
                .filter(item => item.text.toLowerCase().includes(search.toLowerCase()))
                .filter(item => activeListTab === 'planned' ? !item.completed : item.completed);

            if (!user && isOnline) return <div className="flex items-center justify-center h-screen bg-slate-50 dark:bg-slate-900"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600"></div></div>;

            // --- HOME VIEW ---
            if (view === 'home') {
                return (
                    <div className="min-h-screen bg-slate-50 dark:bg-slate-900 flex flex-col font-sans animate-fade-in transition-colors duration-300">
                        {/* HEADER SECTION */}
                        <div className="bg-emerald-600 p-8 pb-12 rounded-b-[2.5rem] shadow-lg relative z-10">
                            <div className="absolute top-4 right-4 flex items-center gap-2">
                                <button onClick={() => setDarkMode(!darkMode)} className="text-white/80 hover:text-white p-1">
                                    {darkMode ? <Icons.Sun size={20}/> : <Icons.Moon size={20}/>}
                                </button>
                                {user && !user.isAnonymous ? (
                                    <>
                                        <img src={user.photoURL} className="w-8 h-8 rounded-full border-2 border-white" alt="Profil" />
                                        <button onClick={logout} className="text-xs text-white/80 hover:text-white underline">Çıkış</button>
                                    </>
                                ) : (
                                    <button onClick={signInWithGoogle} className="bg-white text-gray-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1 shadow-sm hover:bg-gray-100 transition-colors">
                                        <Icons.Google className="w-3 h-3"/> Giriş Yap
                                    </button>
                                )}
                            </div>
                            <div className="text-center">
                                <Icons.Map className="w-16 h-16 text-white mx-auto mb-4 opacity-90" />
                                <h1 className="text-3xl font-bold text-white mb-2">Gezgin</h1>
                                <p className="text-emerald-100">{user && !user.isAnonymous ? `Merhaba, ${user.displayName.split(' ')[0]}!` : 'Ortak Seyahat Planlayıcı'}</p>
                            </div>
                        </div>

                        {/* CONTENT SECTION */}
                        <div className="flex-1 px-6 -mt-8 pb-24 max-w-md mx-auto w-full relative z-20">
                            <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-xl overflow-hidden min-h-[400px]">
                                {/* TABS */}
                                <div className="flex border-b border-gray-100 dark:border-slate-700">
                                    <button onClick={() => setHomeTab('actions')} className={`flex-1 py-4 text-sm font-semibold flex items-center justify-center gap-2 transition-colors ${homeTab === 'actions' ? 'text-emerald-600 border-b-2 border-emerald-600 bg-emerald-50/50 dark:bg-emerald-900/20' : 'text-gray-400 hover:text-gray-600 dark:text-gray-500'}`}><Icons.Home size={18}/> Ana Sayfa</button>
                                    <button onClick={() => setHomeTab('mylists')} className={`flex-1 py-4 text-sm font-semibold flex items-center justify-center gap-2 transition-colors ${homeTab === 'mylists' ? 'text-emerald-600 border-b-2 border-emerald-600 bg-emerald-50/50 dark:bg-emerald-900/20' : 'text-gray-400 hover:text-gray-600 dark:text-gray-500'}`}><Icons.List size={18}/> Listelerim</button>
                                </div>

                                {/* TAB CONTENT */}
                                <div className="p-6">
                                    {homeTab === 'actions' ? (
                                        <div className="space-y-8 animate-fade-in">
                                            <div className="space-y-4">
                                                <h2 className="text-lg font-semibold text-gray-700 dark:text-gray-200 flex items-center gap-2"><Icons.Plus className="w-5 h-5 text-emerald-600" /> Yeni Liste Oluştur</h2>
                                                <div className="flex flex-col gap-3">
                                                    <input type="text" placeholder="Örn: İtalya" className="w-full px-4 py-3 border border-gray-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl focus:ring-2 focus:ring-emerald-500 focus:outline-none" value={newItemText} onChange={(e) => setNewItemText(e.target.value)} />
                                                    <button onClick={createList} disabled={!newItemText.trim()} className="w-full bg-emerald-600 hover:bg-emerald-700 disabled:opacity-50 text-white px-6 py-3 rounded-xl font-medium transition-colors">Oluştur</button>
                                                </div>
                                            </div>
                                            <div className="relative"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-200 dark:border-slate-700"></div></div><div className="relative flex justify-center text-sm"><span className="px-2 bg-white dark:bg-slate-800 text-gray-500">veya</span></div></div>
                                            <div className="space-y-4">
                                                <h2 className="text-lg font-semibold text-gray-700 dark:text-gray-200 flex items-center gap-2"><Icons.Users className="w-5 h-5 text-blue-600" /> Listeye Katıl</h2>
                                                <div className="flex flex-col gap-3">
                                                    <input type="text" placeholder="KOD" className="w-full px-4 py-3 border border-gray-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none uppercase" value={joinCode} onChange={(e) => setJoinCode(e.target.value)} />
                                                    <button onClick={() => joinList()} disabled={!joinCode.trim()} className="w-full bg-blue-600 hover:bg-blue-700 disabled:opacity-50 text-white px-6 py-3 rounded-xl font-medium transition-colors">Katıl</button>
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="space-y-3 animate-fade-in">
                                            {history.length > 0 ? history.map((h) => (
                                                <button key={h.id} onClick={() => joinList(h.id)} className="w-full bg-white dark:bg-slate-700 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-slate-600 flex items-center justify-between hover:shadow-md transition-all group">
                                                    <div className="flex items-center gap-3">
                                                        <div className="bg-emerald-100 dark:bg-emerald-900 p-2 rounded-lg text-emerald-600 dark:text-emerald-400 group-hover:bg-emerald-600 group-hover:text-white transition-colors"><Icons.MapPin size={18}/></div>
                                                        <div className="text-left">
                                                            <div className="font-medium text-gray-800 dark:text-gray-200">{h.title || 'İsimsiz Liste'}</div>
                                                            <div className="text-xs text-gray-400 font-mono tracking-wider">{h.id}</div>
                                                        </div>
                                                    </div>
                                                    <Icons.ArrowRight size={16} className="text-gray-300 group-hover:text-emerald-500"/>
                                                </button>
                                            )) : <div className="text-center py-10 text-gray-400"><Icons.List className="w-12 h-12 mx-auto mb-2 opacity-20"/><p>Henüz kayıtlı bir listen yok.</p></div>}
                                        </div>
                                    )}
                                </div>
                            </div>
                            {error && <div className="mt-4 text-red-500 bg-red-50 dark:bg-red-900/30 dark:text-red-300 px-4 py-2 rounded-lg border border-red-100 dark:border-red-900 text-sm max-w-md text-center font-semibold">{error}</div>}
                        </div>
                    </div>
                );
            }

            // --- LIST VIEW ---
            const completedCount = listData.items?.filter(i => i.completed).length || 0;
            const totalCount = listData.items?.length || 0;
            const progress = totalCount === 0 ? 0 : Math.round((completedCount / totalCount) * 100);
            const isOwner = listData.createdBy === user.uid;

            return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-900 font-sans animate-fade-in pb-safe transition-colors duration-300">
                    {/* SETTINGS MODAL */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-md p-6 shadow-2xl animate-fade-in overflow-y-auto max-h-[90vh]">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold text-gray-800 dark:text-white flex items-center gap-2"><Icons.Settings size={24}/> Liste Ayarları</h2>
                                    <button onClick={() => setShowSettings(false)} className="p-2 bg-gray-100 dark:bg-slate-700 rounded-full hover:bg-gray-200 dark:hover:bg-slate-600 dark:text-white"><Icons.X size={20}/></button>
                                </div>
                                
                                <div className="space-y-6 text-gray-800 dark:text-gray-200">
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Liste İsmi</label>
                                        <div className="flex gap-2">
                                            <input type="text" value={editTitle} onChange={(e) => setEditTitle(e.target.value)} className="flex-1 px-3 py-2 border dark:border-slate-600 dark:bg-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                                            <button onClick={updateListTitle} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Kaydet</button>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Tema Rengi</label>
                                        <div className="flex gap-3 overflow-x-auto pb-2">
                                            {Object.entries(THEMES).map(([key, val]) => (
                                                <button key={key} onClick={() => changeTheme(key)} className={`w-10 h-10 rounded-full ${val.bg} border-2 ${listData.theme === key ? 'border-gray-800 scale-110' : 'border-transparent'} shadow-sm transition-all`} title={val.name}></button>
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Katılımcılar</label>
                                        <div className="space-y-2 max-h-40 overflow-y-auto border dark:border-slate-600 rounded-lg p-2 bg-gray-50 dark:bg-slate-700">
                                            {Object.entries(listData.participants || {}).map(([uid, p]) => (
                                                <div key={uid} className="flex items-center justify-between p-2 bg-white dark:bg-slate-600 rounded-md shadow-sm">
                                                    <div className="flex items-center gap-2">
                                                        {p.photo ? <img src={p.photo} className="w-8 h-8 rounded-full"/> : <div className="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-xs">{p.name?.[0]}</div>}
                                                        <span className="text-sm font-medium">{p.name}</span>
                                                        {uid === listData.createdBy && <span className="text-xs bg-yellow-100 text-yellow-800 px-1.5 py-0.5 rounded">Yönetici</span>}
                                                    </div>
                                                    {isOwner && uid !== user.uid && (
                                                        <button onClick={() => removeParticipant(uid)} className="text-red-500 hover:bg-red-50 p-1 rounded"><Icons.Trash2 size={16}/></button>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <hr className="border-gray-200 dark:border-slate-700"/>
                                    <div className="space-y-3">
                                        {!isOwner && (
                                            <button onClick={leaveList} className="w-full py-3 rounded-xl border border-red-200 text-red-600 font-medium hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors flex items-center justify-center gap-2">
                                                <Icons.LogOut size={18}/> Listeden Ayrıl
                                            </button>
                                        )}
                                        {isOwner && (
                                            <button onClick={deleteList} className="w-full py-3 rounded-xl bg-red-100 dark:bg-red-900/30 text-red-600 font-medium hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors flex items-center justify-center gap-2">
                                                <Icons.Trash2 size={18}/> Listeyi Kalıcı Sil
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* HEADER */}
                    <div className={`${currentTheme.bg} text-white pb-36 rounded-b-[2.5rem] shadow-lg sticky top-0 z-10 transition-colors duration-500 pt-safe`}>
                        <div className="max-w-3xl mx-auto p-6">
                            <div className="flex justify-between items-start mb-6">
                                <button onClick={exitList} className="p-2 bg-black/20 hover:bg-black/30 rounded-lg transition-colors flex items-center gap-2 text-sm backdrop-blur-sm">
                                    <Icons.ArrowRight size={16} className="rotate-180" /> Geri
                                </button>
                                <div className="flex gap-2">
                                    <button onClick={() => setDarkMode(!darkMode)} className="p-2 bg-black/20 hover:bg-black/30 rounded-full backdrop-blur-sm border border-white/20">
                                        {darkMode ? <Icons.Sun size={20}/> : <Icons.Moon size={20}/>}
                                    </button>
                                    <button onClick={copyCodeToClipboard} className="flex items-center gap-2 bg-black/20 hover:bg-black/30 px-4 py-2 rounded-full backdrop-blur-sm transition-all border border-white/20">
                                        <span className="font-mono text-lg font-bold tracking-wider">{listId}</span>
                                        {copySuccess ? <span className="text-xs">Kopyalandı!</span> : <Icons.Copy size={16} />}
                                    </button>
                                    <button onClick={() => setShowSettings(true)} className="p-2 bg-black/20 hover:bg-black/30 rounded-full backdrop-blur-sm border border-white/20">
                                        <Icons.Settings size={20} />
                                    </button>
                                </div>
                            </div>
                            <h1 className="text-3xl md:text-4xl font-bold mb-2">{listData.title}</h1>
                            
                            {/* SEARCH BAR & VIEW TOGGLE */}
                            <div className="flex gap-2 mt-4 bg-white/10 p-1.5 rounded-xl backdrop-blur-sm">
                                <div className="flex-1 flex items-center gap-2 px-3 bg-white/20 rounded-lg">
                                    <Icons.Search size={18} className="text-white/70"/>
                                    <input 
                                        type="text" 
                                        placeholder="Ara..." 
                                        className="bg-transparent border-none outline-none text-white placeholder-white/60 w-full py-2"
                                        value={search}
                                        onChange={(e) => setSearch(e.target.value)}
                                    />
                                </div>
                                <button onClick={() => setLayout('list')} className={`p-2 rounded-lg transition-colors ${layout === 'list' ? 'bg-white text-' + currentTheme.text.split('-')[1] + '-600' : 'text-white hover:bg-white/20'}`}>
                                    <Icons.List size={20}/>
                                </button>
                                <button onClick={() => setLayout('grid')} className={`p-2 rounded-lg transition-colors ${layout === 'grid' ? 'bg-white text-' + currentTheme.text.split('-')[1] + '-600' : 'text-white hover:bg-white/20'}`}>
                                    <Icons.Grid size={20}/>
                                </button>
                            </div>
                        </div>
                        
                        {/* LIST TABS */}
                        <div className="absolute bottom-0 w-full px-6 pb-2">
                            <div className="max-w-3xl mx-auto flex">
                                <button 
                                    onClick={() => setActiveListTab('planned')}
                                    className={`flex-1 pb-3 text-sm font-bold border-b-4 transition-all ${activeListTab === 'planned' ? 'border-white text-white' : 'border-transparent text-white/60'}`}
                                >
                                    GİDİLECEKLER
                                </button>
                                <button 
                                    onClick={() => setActiveListTab('visited')}
                                    className={`flex-1 pb-3 text-sm font-bold border-b-4 transition-all ${activeListTab === 'visited' ? 'border-white text-white' : 'border-transparent text-white/60'}`}
                                >
                                    GİDİLENLER
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-3xl mx-auto px-4 -mt-4 pb-10 relative z-20">
                        {/* Input Area (Only visible in planned tab) */}
                        {activeListTab === 'planned' && (
                            <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-lg border border-gray-100 dark:border-slate-700 mb-6">
                                <div className="flex flex-col gap-3 sm:flex-row">
                                    <div className="flex items-center gap-3 flex-1">
                                        <div className={`p-2 ${currentTheme.light} dark:bg-opacity-20 rounded-lg ${currentTheme.text}`}><Icons.Plus size={20} /></div>
                                        <input type="text" placeholder="Rota ekle..." className="flex-1 bg-transparent focus:outline-none text-lg placeholder-gray-400 dark:placeholder-gray-500 text-gray-800 dark:text-white" value={newItemText} onChange={(e) => setNewItemText(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && addItem()} />
                                    </div>
                                    <div className="flex items-center gap-3 pl-12 sm:pl-0 flex-1">
                                        <Icons.MapPin size={16} className="text-gray-400" />
                                        <input type="text" placeholder="Konum veya Link (Opsiyonel)" className="flex-1 bg-transparent focus:outline-none text-sm placeholder-gray-400 dark:placeholder-gray-500 text-gray-600 dark:text-gray-300" value={newItemLocation} onChange={(e) => setNewItemLocation(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && addItem()} />
                                        <button onClick={addItem} disabled={!newItemText.trim() || addingItem} className={`${currentTheme.bg} hover:opacity-90 text-white p-2 rounded-lg transition-colors disabled:opacity-50`}>
                                            {addingItem ? <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> : <Icons.ArrowRight size={20} />}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {error && <div className="mb-4 bg-red-100 text-red-700 p-3 rounded-lg text-sm">{error}</div>}

                        {/* Items List */}
                        <div className={layout === 'grid' ? 'grid grid-cols-2 gap-3' : 'space-y-3'}>
                            {filteredItems.map((item, index) => (
                                <div 
                                    key={item.id} 
                                    draggable={activeListTab === 'planned' && layout === 'list'}
                                    onDragStart={() => (dragItem.current = index)}
                                    onDragEnter={() => (dragOverItem.current = index)}
                                    onDragEnd={handleSort}
                                    onDragOver={(e) => e.preventDefault()}
                                    className={`group bg-white dark:bg-slate-800 p-3 rounded-2xl shadow-sm border border-gray-100 dark:border-slate-700 flex ${layout === 'grid' ? 'flex-col' : 'gap-4'} transition-all hover:shadow-md relative`}
                                >
                                    {/* Drag Handle (List only) */}
                                    {layout === 'list' && activeListTab === 'planned' && (
                                        <div className="absolute left-1 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-30 cursor-grab active:cursor-grabbing p-1">
                                            <Icons.Drag size={14}/>
                                        </div>
                                    )}

                                    {/* Image */}
                                    {item.image && (
                                        <div className={`${layout === 'grid' ? 'w-full h-32' : 'w-24 h-24'} flex-shrink-0 rounded-xl overflow-hidden bg-gray-100 dark:bg-slate-700 shadow-inner`}>
                                            <img src={item.image} alt={item.text} className="w-full h-full object-cover" onError={(e) => e.target.style.display = 'none'} />
                                        </div>
                                    )}

                                    <div className="flex-1 flex flex-col justify-center min-w-0 gap-2">
                                        
                                        {/* Üst Satır: Checkbox + İsim + Sil */}
                                        <div className="flex items-start gap-3">
                                            <button onClick={() => toggleItem(item.id)} className={`flex-shrink-0 transition-colors pt-1 ${item.completed ? currentTheme.text : 'text-gray-300 hover:' + currentTheme.text}`}>
                                                {item.completed ? <Icons.CheckSquare size={22} /> : <Icons.Square size={22} />}
                                            </button>
                                            
                                            <h3 className={`text-lg font-bold leading-tight flex-1 dark:text-white ${item.completed ? 'text-gray-500 line-through dark:text-gray-500' : 'text-gray-800'}`}>
                                                {item.text}
                                            </h3>

                                            <button onClick={() => deleteItem(item.id)} className="text-gray-300 hover:text-red-500 transition-colors p-1"><Icons.Trash2 size={18} /></button>
                                        </div>

                                        {/* Alt Satır: Bağlantıya Git Butonu + Kim Ekledi */}
                                        <div className="flex flex-wrap items-center gap-3 pl-8 sm:pl-0"> 
                                           
                                           {item.location && (
                                               <a 
                                                 href={item.location.startsWith('http') ? item.location : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`} 
                                                 target="_blank" 
                                                 rel="noopener noreferrer"
                                                 className={`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-semibold ${currentTheme.light} dark:bg-slate-700 ${currentTheme.text} dark:text-emerald-400 hover:opacity-80 transition-opacity`}
                                               >
                                                   <Icons.MapPin size={14} /> Bağlantıya Git
                                               </a>
                                           )}

                                           {item.addedByName && item.addedByName !== 'Misafir' && (
                                                <div className="flex items-center gap-1.5 text-xs text-gray-400">
                                                    {item.addedByPhoto ? (
                                                        <img src={item.addedByPhoto} className="w-5 h-5 rounded-full border border-gray-200" alt="" />
                                                    ) : (
                                                        <div className="w-5 h-5 rounded-full bg-gray-200 flex items-center justify-center text-[10px]">{item.addedByName[0]}</div>
                                                    )}
                                                    <span className="truncate max-w-[80px]">{item.addedByName.split(' ')[0]}</span>
                                                </div>
                                            )}
                                            
                                            {/* Comment Toggle */}
                                            <button onClick={() => setActiveCommentId(activeCommentId === item.id ? null : item.id)} className={`text-xs flex items-center gap-1 ${item.comment ? currentTheme.text : 'text-gray-400 hover:text-gray-600'}`}>
                                                <Icons.MessageSquare size={14}/> {item.comment ? 'Notu Gör' : 'Not Ekle'}
                                            </button>
                                        </div>
                                        
                                        {/* Comment Section */}
                                        {(activeCommentId === item.id || item.comment) && (
                                            <div className={`mt-2 p-2 bg-gray-50 dark:bg-slate-700 rounded-lg text-sm ${activeCommentId !== item.id && 'hidden'}`}>
                                                <textarea 
                                                    className="w-full bg-transparent outline-none resize-none text-gray-700 dark:text-gray-200" 
                                                    placeholder="Notunuzu buraya yazın..."
                                                    rows="2"
                                                    defaultValue={item.comment}
                                                    onBlur={(e) => updateComment(item.id, e.target.value)}
                                                ></textarea>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))}
                            {filteredItems.length === 0 && (
                                <div className="text-center py-12 text-gray-400 dark:text-slate-600">
                                    <p>{activeListTab === 'planned' ? 'Planlanmış rota yok.' : 'Henüz gidilen bir yer yok.'}</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TravelPlanner />);
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js').catch(() => {});
            });
        }
    </script>
</body>
</html>
